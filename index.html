<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EVSEPARKER Control Interface</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .connection-status {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 4px;
    }
    .connection-status.connected {
      background-color: #dff0d8;
      color: #3c763d;
    }
    .connection-status.disconnected {
      background-color: #f2dede;
      color: #a94442;
    }
    .charge-state {
      font-size: 1.5em;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      text-align: center;
    }
    .charge-state.no-ev { background-color: #d3d3d3; }
    .charge-state.connected { background-color: #dff0d8; }
    .charge-state.charging { background-color: #d9edf7; }
    .charge-state.error { background-color: #f2dede; }
    .error-banner {
      display: none;
      background-color: #f2dede;
      color: #a94442;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .error-banner.active { display: block; }
    .control-button {
      padding: 10px 20px;
      font-size: 1em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .control-button.start { background-color: #5cb85c; color: white; }
    .control-button.stop { background-color: #d9534f; color: white; }
    .control-button.reset { background-color: #f0ad4e; color: white; }
    .control-button:disabled { background-color: #ccc; cursor: not-allowed; }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background-color: #f4f4f4;
      margin-right: 5px;
      border-radius: 4px 4px 0 0;
    }
    .tab.active {
      background-color: white;
      border-bottom: 1px solid white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .status-item {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }
    .status-item label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .settings-item {
      display: flex;
      flex-direction: column;
    }
    .settings-item label {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .slider {
      width: 100%;
    }
    .logs {
      max-height: 200px;
      overflow-y: auto;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .logs p {
      margin: 5px 0;
      font-size: 0.9em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th { background-color: #f4f4f4; }
    @media (max-width: 600px) {
      .settings-grid { grid-template-columns: 1fr; }
      .status-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="connection-status disconnected" id="connectionStatus">Disconnected</div>
    <button id="connectButton" class="control-button start" onclick="connectBLE()">Connect to BLE Device</button>
    <button id="disconnectButton" class="control-button stop" onclick="disconnectBLE()" disabled>Disconnect</button>
    <div class="charge-state no-ev" id="chargeState">NO EV</div>
    <div class="error-banner" id="errorBanner">
      <p><strong>Safety Status:</strong> <span id="safetyStatus">Unknown</span></p>
      <p><strong>Error Cause:</strong> <span id="errorCause">None</span></p>
    </div>
    <div class="status-grid">
      <div class="status-item">
        <label>Power (W)</label>
        <span id="power">0</span>
      </div>
      <div class="status-item">
        <label>Current (A)</label>
        <span id="current">0.00</span>
      </div>
      <div class="status-item">
        <label>Energy (kWh)</label>
        <span id="deliveredEnergy">0.000</span>
      </div>
      <div class="status-item">
        <label>Time</label>
        <span id="time">0 s</span>
      </div>
      <div class="status-item">
        <label>Temperature (°C)</label>
        <span id="temperature">0.00</span>
      </div>
      <div class="status-item">
        <label>MAC Address</label>
        <span id="macAddress">Unknown</span>
      </div>
      <div class="status-item">
        <label>Firmware Version</label>
        <span id="firmwareVersion">Unknown</span>
      </div>
    </div>
    <button id="controlButton" class="control-button start" disabled>Start</button>
    <div class="tabs">
      <div class="tab active" onclick="showTab('main')">Main</div>
      <div class="tab" onclick="showTab('settings')">Settings</div>
      <div class="tab" onclick="showTab('sessions')">Sessions</div>
      <div class="tab" onclick="showTab('debug')">Debug</div>
    </div>
    <div id="main" class="tab-content active">
      <p>Control your EVSEPARKER charging station.</p>
    </div>
    <div id="settings" class="tab-content">
      <div class="settings-grid">
        <div class="settings-item">
          <label>Current Limit (A)</label>
          <input type="range" id="currentSlider" class="slider" min="6" max="32" value="6" step="1">
          <span id="currentValue">6 A (C6)</span>
        </div>
        <div class="settings-item">
          <label>Error on State D</label>
          <label class="switch">
            <input type="checkbox" id="errorOnStateD">
            <span class="slider round"></span>
          </label>
          <span id="errorOnStateDValue">OFF</span>
        </div>
        <div class="settings-item">
          <label>Temperature Threshold (°C)</label>
          <input type="range" id="tempThresholdSlider" class="slider" min="50" max="80" value="60" step="0.1">
          <span id="tempThresholdValue">60.0 °C</span>
        </div>
        <div class="settings-item">
          <label>Current % Limit</label>
          <input type="range" id="currentPercentLimitSlider" class="slider" min="0" max="30" value="0" step="1">
          <span id="currentPercentLimitValue">0%</span>
        </div>
      </div>
      <button class="control-button start" onclick="saveSettings()">Save Settings</button>
    </div>
    <div id="sessions" class="tab-content">
      <table>
        <thead>
          <tr>
            <th>Duration</th>
            <th>Energy (kWh)</th>
            <th>Avg Power (W)</th>
          </tr>
        </thead>
        <tbody id="sessionLogs"></tbody>
      </table>
    </div>
    <div id="debug" class="tab-content">
      <div class="settings-grid">
        <div class="settings-item">
          <label>Mode</label>
          <span id="modeDebug">AUTO</span>
        </div>
        <div class="settings-item">
          <label>CP Duty (%)</label>
          <span id="cpDuty">0.00</span>
        </div>
        <div class="settings-item">
          <label>CP In ADC (Min/Max)</label>
          <span id="cpInAdcDebug">0/0</span>
        </div>
        <div class="settings-item">
          <label>Relays</label>
          <span id="relaysDebug">OFF</span>
        </div>
        <div class="settings-item">
          <label>Current (A)</label>
          <span id="currentDebug">0.00</span>
        </div>
        <div class="settings-item">
          <label>Power (W)</label>
          <span id="powerDebug">0</span>
        </div>
        <div class="settings-item">
          <label>Phase Status</label>
          <span id="phaseStatus">Unknown</span>
        </div>
        <div class="settings-item">
          <label>GFCI Test Result</label>
          <span id="gfciTestResult">NOT_RUN</span>
        </div>
        <div class="settings-item">
          <label>Phase Weld Test Result</label>
          <span id="phaseWeldTestResult">NOT_OK</span>
        </div>
        <div class="settings-item">
          <label>Safety Status</label>
          <span id="safetyStatusDebug">OK</span>
        </div>
        <div class="settings-item">
          <label>Error Cause</label>
          <span id="errorCauseDebug">None</span>
        </div>
        <div class="settings-item">
          <label>Manual Duty (%)</label>
          <select id="dutySelect">
            <option value="0">0</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="30">30</option>
            <option value="40">40</option>
            <option value="50">50</option>
            <option value="60">60</option>
            <option value="70">70</option>
            <option value="80">80</option>
            <option value="90">90</option>
            <option value="100">100</option>
          </select>
          <button class="control-button start" onclick="sendCommand(`MANUAL ${document.getElementById('dutySelect').value}`)">Set Duty</button>
        </div>
      </div>
      <button class="control-button start" onclick="sendCommand('RELAY_ON')">Relay ON</button>
      <button class="control-button stop" onclick="sendCommand('RELAY_OFF')">Relay OFF</button>
      <button class="control-button start" onclick="sendCommand('TEST_GFCI')">Test GFCI</button>
      <button class="control-button start" onclick="sendCommand('TEST_PHASE')">Test Phase</button>
      <button class="control-button start" onclick="sendCommand('TEST_WELD')">Test Weld</button>
      <button class="control-button start" onclick="sendCommand('TEST_EARTH_RELAY')">Test Earth Relay</button>
      <div class="logs" id="testLogs"></div>
    </div>
  </div>
  <script>
    let device = null;
    let stateCharacteristic = null;
    let commandCharacteristic = null;
    let pollInterval = null;
    let isEditingSettings = false;
    let lastCurrentSetting = 'C6';
    const serviceUUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
    const stateUUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
    const commandUUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
    const currentSettings = [
      { value: 6, label: 'C6', command: 'C6' },
      { value: 9, label: 'C9', command: 'C9' },
      { value: 10, label: 'C10', command: 'C10' },
      { value: 16, label: 'C16', command: 'C16' },
      { value: 32, label: 'C32', command: 'C32' }
    ];

    function logMessage(message) {
      console.log(message);
      const logsDiv = document.getElementById('testLogs');
      const p = document.createElement('p');
      p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logsDiv.appendChild(p);
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    function checkBluetoothSupport() {
      if (!navigator.bluetooth) {
        alert('Web Bluetooth is not supported. Use Chrome or Edge on Windows, macOS, or Android. On Linux, ensure bluez 5.50+ and experimental flags.');
        return false;
      }
      navigator.bluetooth.getAvailability().then(available => {
        logMessage(`Bluetooth available: ${available}`);
      });
      return true;
    }

    async function connectBLE() {
      if (!checkBluetoothSupport()) return;
      try {
        logMessage('Requesting Bluetooth device...');
        device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'EVSEPARKER' }],
          optionalServices: [serviceUUID]
        });
        document.getElementById('connectionStatus').textContent = 'Connecting...';
        document.getElementById('connectButton').disabled = true;
        document.getElementById('disconnectButton').disabled = false;
        logMessage('Connecting to GATT server...');
        const server = await Promise.race([
          device.gatt.connect(),
          new Promise((_, reject) => setTimeout(() => reject(new Error('GATT connection timeout')), 10000))
        ]);
        logMessage('Connected to GATT server');
        const service = await server.getPrimaryService(serviceUUID);
        logMessage('Service found');
        stateCharacteristic = await service.getCharacteristic(stateUUID);
        logMessage('State characteristic accessed');
        commandCharacteristic = await service.getCharacteristic(commandUUID);
        logMessage('Command characteristic accessed');
        document.getElementById('connectionStatus').textContent = 'Connected';
        document.getElementById('connectionStatus').className = 'connection-status connected';
        document.getElementById('controlButton').disabled = false;
        logMessage('Starting state polling...');
        pollInterval = setInterval(async () => {
		  try {
			const value = await stateCharacteristic.readValue();
			handleStateUpdate({ target: { value } });
		  } catch (pollError) {
			logMessage(`Poll error: ${pollError.message}`);
		  }
		}, 2000); // Changed from 1000
        const initialValue = await stateCharacteristic.readValue();
        handleStateUpdate({ target: { value: initialValue } });
      } catch (error) {
        document.getElementById('connectionStatus').textContent = `Connection Failed: ${error.message}`;
        document.getElementById('connectButton').disabled = false;
        document.getElementById('disconnectButton').disabled = true;
        logMessage(`Connection error: ${error.message}`);
        disconnectBLE();
      }
    }

    async function disconnectBLE() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
        logMessage('Stopped state polling');
      }
      if (device && device.gatt.connected) {
        await device.gatt.disconnect();
        logMessage('Disconnected from device');
      }
      document.getElementById('connectionStatus').textContent = 'Disconnected';
      document.getElementById('connectionStatus').className = 'connection-status disconnected';
      document.getElementById('controlButton').disabled = true;
      document.getElementById('connectButton').disabled = false;
      document.getElementById('disconnectButton').disabled = true;
      device = null;
      stateCharacteristic = null;
      commandCharacteristic = null;
    }

    function formatDuration(seconds) {
      if (seconds < 60) return seconds + ' s';
      return Math.floor(seconds / 60) + ' min';
    }

    function updateSettingsUI(data) {
      if (isEditingSettings) return;
      document.getElementById('errorOnStateD').checked = data.errorOnStateD;
      document.getElementById('errorOnStateDValue').innerText = data.errorOnStateD ? 'ON' : 'OFF';
      let tempSlider = document.getElementById('tempThresholdSlider');
      tempSlider.value = data.tempThreshold;
      document.getElementById('tempThresholdValue').innerText = data.tempThreshold.toFixed(1) + ' °C';
      let limitSlider = document.getElementById('currentPercentLimitSlider');
      limitSlider.value = data.currentPercentLimit;
      document.getElementById('currentPercentLimitValue').innerText = data.currentPercentLimit + '%';
      let currentSlider = document.getElementById('currentSlider');
      let currentValue = currentSettings.find(s => s.command === data.currentSetting)?.value || 6;
      currentSlider.value = currentValue;
      document.getElementById('currentValue').innerText = `${currentValue} A (${data.currentSetting})`;
      lastCurrentSetting = data.currentSetting;
    }

    function handleStateUpdate(event) {
      function handleStateUpdate(event) {
	  try {
		const rawData = new TextDecoder().decode(event.target.value);
		if (!rawData) {
		  logMessage("State update error: Empty data received");
		  return;
		}
		const data = JSON.parse(rawData);
        updateSettingsUI(data);
        let chargeState = document.getElementById('chargeState');
        let cpState = data.cpState.toUpperCase();
        let isStateD = cpState.includes('VENTILATION REQUIRED');
        chargeState.innerText = cpState.includes('NO EV') ? 'NO EV' :
                          cpState.includes('EV CONNECTED') ? 'CONNECTED' :
                          cpState.includes('EV CHARGING') ? 'CHARGING' :
                          isStateD && !data.errorOnStateD ? 'CHARGING' : 'VENTILATION REQUIRED';
        chargeState.className = 'charge-state ' + (cpState.includes('NO EV') ? 'no-ev' :
                                                  cpState.includes('EV CONNECTED') ? 'connected' :
                                                  cpState.includes('EV CHARGING') ? 'charging' :
                                                  isStateD && !data.errorOnStateD ? 'charging' : 'error');
        let errorBanner = document.getElementById('errorBanner');
        let isStateDError = isStateD && !data.errorOnStateD;
        if (data.state.toUpperCase() === 'ERROR' && !isStateDError) {
          errorBanner.classList.add('active');
          document.getElementById('safetyStatus').innerText = data.safetyStatus || 'Unknown';
          document.getElementById('errorCause').innerText = data.errorCause || 'None';
        } else {
          errorBanner.classList.remove('active');
        }
        document.getElementById('power').innerText = data.power;
        document.getElementById('current').innerText = data.currentRMS.toFixed(2);
        document.getElementById('deliveredEnergy').innerText = data.deliveredEnergy.toFixed(3);
        document.getElementById('time').innerText = formatDuration(data.time);
        document.getElementById('temperature').innerText = data.temperature.toFixed(2);
        document.getElementById('macAddress').innerText = data.macAddress;
        document.getElementById('firmwareVersion').innerText = data.firmwareVersion;
        let controlButton = document.getElementById('controlButton');
        if (data.state.toUpperCase() === 'ERROR' && data.resetButtonEnabled) {
          controlButton.innerText = 'Reset';
          controlButton.className = 'control-button reset';
          controlButton.disabled = false;
        } else if (data.state.toUpperCase() === 'CHARGING' && data.stopButtonEnabled) {
          controlButton.innerText = 'Stop';
          controlButton.className = 'control-button stop';
          controlButton.disabled = false;
        } else if (data.startButtonEnabled) {
          controlButton.innerText = 'Start';
          controlButton.className = 'control-button start';
          controlButton.disabled = false;
        } else {
          controlButton.innerText = data.state.toUpperCase() === 'CHARGING' ? 'Stop' : 'Start';
          controlButton.className = 'control-button ' + (data.state.toUpperCase() === 'CHARGING' ? 'stop' : 'start');
          controlButton.disabled = true;
        }
        document.getElementById('modeDebug').innerText = data.mode;
        document.getElementById('cpDuty').innerText = data.currentDuty.toFixed(2);
        document.getElementById('cpInAdcDebug').innerText = `${data.cpInMinAdc}/${data.cpInMaxAdc}`;
        document.getElementById('relaysDebug').innerText = data.relays;
        document.getElementById('currentDebug').innerText = data.currentRMS.toFixed(2);
        document.getElementById('powerDebug').innerText = data.power;
        document.getElementById('phaseStatus').innerText = data.phaseStatus;
        document.getElementById('gfciTestResult').innerText = data.gfciTestResult;
        document.getElementById('phaseWeldTestResult').innerText = data.phaseWeldTestResult;
        document.getElementById('safetyStatusDebug').innerText = data.safetyStatus;
        document.getElementById('errorCauseDebug').innerText = data.errorCause;
        document.getElementById('dutySelect').value = data.currentDuty.toFixed(2);
        let testLogs = document.getElementById('testLogs');
        testLogs.innerHTML = '';
        let reversedLogs = [...data.testLogs].reverse();
        reversedLogs.forEach(log => {
          let p = document.createElement('p');
          p.innerText = log;
          testLogs.appendChild(p);
        });
        let sessionLogs = document.getElementById('sessionLogs');
        sessionLogs.innerHTML = '';
        data.sessionLogs.forEach(session => {
          let tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${formatDuration(session.duration)}</td>
            <td>${session.energy.toFixed(3)}</td>
            <td>${Math.round(session.avgPower)}</td>
          `;
          sessionLogs.appendChild(tr);
        });
      } catch (error) {
		logMessage(`State update error: ${error.message} (Raw data: ${rawData})`);
      }
    }

    async function sendCommand(cmd) {
	  if (!device || !device.gatt.connected || !commandCharacteristic) {
		logMessage('Error: Not connected to device or command characteristic');
		disconnectBLE();
		return;
	  }
	  try {
		const data = JSON.stringify({ command: cmd });
		await commandCharacteristic.writeValue(new TextEncoder().encode(data));
		logMessage(`Sent command: ${cmd}`);
	  } catch (error) {
		logMessage(`Command send error: ${error.message}`);
		disconnectBLE();
	  }
	}

    function sendControlCommand() {
      let button = document.getElementById('controlButton');
      if (button.innerText === 'Reset') sendCommand('RESET');
      else if (button.innerText === 'Stop') sendCommand('STOP');
      else if (button.innerText === 'Start') sendCommand('START');
    }

    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
      if (tabId === 'debug') {
        sendCommand('MANUAL 0');
      } else if (tabId === 'main') {
        sendCommand('AUTO');
      }
    }

    function updateSliderValue(value) {
      let setting = currentSettings.find(s => s.value <= value) || currentSettings[0];
      if (value > 32) setting = currentSettings[currentSettings.length - 1];
      else if (value > 16) setting = currentSettings.find(s => s.value === 32);
      else if (value > 10) setting = currentSettings.find(s => s.value === 16);
      else if (value > 9) setting = currentSettings.find(s => s.value === 10);
      else if (value > 6) setting = currentSettings.find(s => s.value === 9);
      document.getElementById('currentValue').innerText = `${value} A (${setting.label})`;
      lastCurrentSetting = setting.command;
      sendCommand(setting.command);
    }

    function saveSettings() {
      let errorOnStateD = document.getElementById('errorOnStateD').checked;
      let tempThreshold = parseFloat(document.getElementById('tempThresholdSlider').value);
      let currentPercentLimit = parseInt(document.getElementById('currentPercentLimitSlider').value);
      if (isNaN(tempThreshold) || tempThreshold < 50.0 || tempThreshold > 80.0) {
        alert('Temperature threshold must be between 50.0 and 80.0 °C');
        return;
      }
      if (isNaN(currentPercentLimit) || currentPercentLimit < 0 || currentPercentLimit > 30) {
        alert('Current percentage limit must be between 0 and 30%');
        return;
      }
      isEditingSettings = true;
      document.getElementById('errorOnStateDValue').innerText = errorOnStateD ? 'ON' : 'OFF';
      document.getElementById('tempThresholdValue').innerText = tempThreshold.toFixed(1) + ' °C';
      document.getElementById('currentPercentLimitValue').innerText = currentPercentLimit + '%';
      sendCommand(`SETTINGS ${errorOnStateD} ${tempThreshold.toFixed(1)} ${currentPercentLimit}`);
      setTimeout(() => { isEditingSettings = false; }, 500);
    }

    document.getElementById('controlButton').addEventListener('click', sendControlCommand);
    document.getElementById('currentSlider').addEventListener('change', function() {
      updateSliderValue(this.value);
    });
    document.getElementById('tempThresholdSlider').addEventListener('input', function() {
      document.getElementById('tempThresholdValue').innerText = this.value + ' °C';
    });
    document.getElementById('currentPercentLimitSlider').addEventListener('input', function() {
      document.getElementById('currentPercentLimitValue').innerText = this.value + '%';
    });
  </script>
</body>
</html>
