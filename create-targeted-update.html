<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Targeted Update - EVSEPARKER Management</title>
    <style>
        :root {
            --primary-color: #2ecc71;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-bg: #2c3e50;
            --light-bg: #ecf0f1;
            --card-bg: #ffffff;
            --text-dark: #2c3e50;
            --text-light: #ffffff;
            --text-muted: #7f8c8d;
            --border-color: #bdc3c7;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--light-bg);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .header {
            background: var(--dark-bg);
            color: var(--text-light);
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .form-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: var(--text-light);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: var(--text-light);
        }

        .btn-warning {
            background: var(--warning-color);
            color: var(--text-dark);
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .fix-list {
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .fix-item {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: flex-start;
        }

        .fix-item input {
            flex: 1;
            margin-bottom: 0;
        }

        .fix-item button {
            padding: 0.5rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .output-section {
            background: var(--dark-bg);
            color: var(--text-light);
            padding: 2rem;
            border-radius: 15px;
            margin-top: 2rem;
        }

        .output-section pre {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        .warning-box {
            background: var(--warning-color);
            color: var(--text-dark);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .success-box {
            background: var(--primary-color);
            color: var(--text-light);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Create Targeted Firmware Update</h1>
            <p>Generate MAC-specific firmware update configurations for customer support</p>
        </div>

        <div class="warning-box">
            <strong>‚ö†Ô∏è Important:</strong> Targeted updates should only be created for specific customer issues. Always test custom firmware thoroughly before deployment.
        </div>

        <div class="form-card">
            <h2>Customer Information</h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="macAddress">MAC Address *</label>
                    <input type="text" id="macAddress" placeholder="AB:CD:EF:12:34:56" required>
                </div>
                <div class="form-group">
                    <label for="deviceSerial">Device Serial</label>
                    <input type="text" id="deviceSerial" placeholder="EVSE-2024-001234">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="customerName">Customer Name</label>
                    <input type="text" id="customerName" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label for="issueTicket">Support Ticket</label>
                    <input type="text" id="issueTicket" placeholder="SUPPORT-2024-789">
                </div>
            </div>

            <div class="form-group">
                <label for="issueNotes">Issue Description</label>
                <textarea id="issueNotes" placeholder="Describe the customer's reported issue..."></textarea>
            </div>
        </div>

        <div class="form-card">
            <h2>Firmware Configuration</h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="hardwareModel">Hardware Model *</label>
                    <select id="hardwareModel" required>
                        <option value="">Select Model</option>
                        <option value="EVSEPARKER_V2_GEN1">EVSEPARKER V2 GEN1</option>
                        <option value="EVSEPARKER_V2_GEN2">EVSEPARKER V2 GEN2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="customVersion">Custom Version *</label>
                    <input type="text" id="customVersion" placeholder="10.2.1-custom-relay-fix" required>
                </div>
            </div>

            <div class="form-group">
                <label for="changelogText">Changelog Description *</label>
                <textarea id="changelogText" placeholder="Brief description of the custom firmware changes..." required></textarea>
            </div>

            <div class="form-group">
                <label for="fileSize">File Size</label>
                <input type="text" id="fileSize" placeholder="1.16 MB">
            </div>

            <div class="form-group">
                <label>Targeted Fixes</label>
                <div class="fix-list" id="fixList">
                    <div class="fix-item">
                        <input type="text" placeholder="Describe specific fix..." id="fix0">
                        <button onclick="removeFix(0)">‚úï</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addFix()" style="margin-top: 0.5rem;">+ Add Fix</button>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="rollbackVersion">Rollback Version</label>
                    <input type="text" id="rollbackVersion" placeholder="10.2.0">
                </div>
                <div class="form-group">
                    <label for="expiryDate">Expiry Date</label>
                    <input type="date" id="expiryDate">
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-bottom: 2rem;">
            <button type="button" class="btn btn-primary" onclick="generateConfig()">üéØ Generate Targeted Update</button>
            <button type="button" class="btn btn-warning" onclick="clearForm()">üîÑ Clear Form</button>
        </div>

        <div id="outputSection" class="output-section" style="display: none;">
            <h2>Generated Configuration</h2>
            <div class="success-box">
                <strong>‚úÖ Configuration Generated Successfully!</strong>
                <p>File name: <span id="fileName"></span></p>
                <p>Directory: <code>/targeted/firmware/<span id="directoryName"></span>/</code></p>
            </div>

            <h3>1. Save this JSON as: <code id="jsonFileName"></code></h3>
            <pre id="jsonOutput"></pre>

            <h3>2. Upload Instructions</h3>
            <div style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <p><strong>Steps to deploy:</strong></p>
                <ol style="padding-left: 1.2rem; margin-top: 0.5rem;">
                    <li>Save the JSON configuration to <code>targeted/[MAC_ADDRESS].json</code></li>
                    <li>Create directory <code>targeted/firmware/[MAC_ADDRESS]/</code></li>
                    <li>Upload your custom firmware binary to the directory</li>
                    <li>Update the URL in the JSON to point to your firmware file</li>
                    <li>Test the targeted update with the customer's MAC address</li>
                </ol>
            </div>

            <button type="button" class="btn btn-secondary" onclick="copyToClipboard()">üìã Copy JSON to Clipboard</button>
        </div>
    </div>

    <script>
        let fixCount = 1;

        function addFix() {
            const fixList = document.getElementById('fixList');
            const newFix = document.createElement('div');
            newFix.className = 'fix-item';
            newFix.innerHTML = `
                <input type="text" placeholder="Describe specific fix..." id="fix${fixCount}">
                <button onclick="removeFix(${fixCount})">‚úï</button>
            `;
            fixList.appendChild(newFix);
            fixCount++;
        }

        function removeFix(index) {
            const fixElement = document.getElementById(`fix${index}`).parentElement;
            fixElement.remove();
        }

        function clearForm() {
            if (confirm('Are you sure you want to clear all form data?')) {
                document.querySelectorAll('input, textarea, select').forEach(element => {
                    element.value = '';
                });
                document.getElementById('outputSection').style.display = 'none';
            }
        }

        function generateConfig() {
            // Validate required fields
            const macAddress = document.getElementById('macAddress').value.trim();
            const hardwareModel = document.getElementById('hardwareModel').value;
            const customVersion = document.getElementById('customVersion').value.trim();
            const changelogText = document.getElementById('changelogText').value.trim();

            if (!macAddress || !hardwareModel || !customVersion || !changelogText) {
                alert('Please fill in all required fields (marked with *)');
                return;
            }

            // Validate MAC address format
            const macRegex = /^([0-9A-F]{2}[:-]){5}([0-9A-F]{2})$/i;
            if (!macRegex.test(macAddress)) {
                alert('Please enter a valid MAC address format (XX:XX:XX:XX:XX:XX)');
                return;
            }

            // Collect fix descriptions
            const fixes = [];
            document.querySelectorAll('[id^="fix"]').forEach(input => {
                if (input.value.trim()) {
                    fixes.push(input.value.trim());
                }
            });

            // Set default expiry date if not provided (3 months from now)
            let expiryDate = document.getElementById('expiryDate').value;
            if (!expiryDate) {
                const futureDate = new Date();
                futureDate.setMonth(futureDate.getMonth() + 3);
                expiryDate = futureDate.toISOString().split('T')[0];
            }

            // Generate configuration
            const config = {
                customer_info: {
                    mac_address: macAddress.toUpperCase(),
                    device_serial: document.getElementById('deviceSerial').value || 'N/A',
                    customer_name: document.getElementById('customerName').value || 'N/A',
                    issue_ticket: document.getElementById('issueTicket').value || 'N/A',
                    created_date: new Date().toISOString(),
                    notes: document.getElementById('issueNotes').value || 'No additional notes'
                },
                devices: [{
                    model: hardwareModel,
                    latest_version: customVersion,
                    url: `https://demirciberkan.github.io/targeted/firmware/${macAddress.replace(/:/g, '_')}/${customVersion.replace(/[^a-zA-Z0-9.-]/g, '_')}.bin`,
                    changelog: `üéØ TARGETED FIX: ${changelogText}`,
                    release_date: new Date().toISOString(),
                    file_size: document.getElementById('fileSize').value || 'Unknown',
                    hardware_version: hardwareModel.replace('EVSEPARKER_', ''),
                    targeted_fix: true,
                    fix_description: fixes,
                    rollback_info: {
                        stable_version: document.getElementById('rollbackVersion').value || '10.2.0',
                        stable_url: `https://demirciberkan.github.io/firmware/${hardwareModel}/EVSE_${document.getElementById('rollbackVersion').value?.replace('.', '_') || '10_2_0'}.bin`
                    },
                    security: {
                        signed: true,
                        checksum: 'sha256:' + generateRandomHash(),
                        build_date: new Date().toISOString(),
                        builder: 'engineering@demirciberkan.com'
                    }
                }],
                instructions: {
                    prerequisites: [
                        'Ensure device is connected to power supply',
                        'Verify no active charging session is in progress',
                        'Have mobile app updated to latest version'
                    ],
                    installation: [
                        '1. Open EVSEPARKER mobile app and connect to your device',
                        '2. Navigate to Firmware Update section',
                        `3. Enter MAC address ${macAddress.toUpperCase()} when prompted for targeted update`,
                        '4. Download and install the custom firmware',
                        '5. Device will automatically reboot after installation',
                        `6. Verify new firmware version shows as ${customVersion}`
                    ],
                    verification_tests: [
                        'Test all basic functions after update',
                        'Verify the specific issue has been resolved',
                        'Run a complete charging cycle to ensure stability',
                        'Monitor for any new issues over 24 hour period'
                    ],
                    support_contact: 'berkan@demirciberkan.com'
                },
                monitoring: {
                    success_metrics: [
                        'All basic functions working correctly',
                        'Specific reported issue resolved',
                        'No new issues introduced',
                        'System stable over 48 hour test period'
                    ],
                    reporting: {
                        required_feedback: 'Please report results after 48 hours of operation',
                        feedback_email: 'support@demirciberkan.com',
                        ticket_reference: document.getElementById('issueTicket').value || 'N/A'
                    }
                },
                metadata: {
                    expiry_date: expiryDate + 'T00:00:00Z',
                    auto_rollback: false,
                    priority: 'high',
                    status: 'active',
                    access_count: 0,
                    last_accessed: null
                }
            };

            // Display results
            const macForFile = macAddress.replace(/:/g, '_').toUpperCase();
            const fileName = `${macForFile}.json`;
            const directoryName = macForFile;

            document.getElementById('fileName').textContent = fileName;
            document.getElementById('directoryName').textContent = directoryName;
            document.getElementById('jsonFileName').textContent = fileName;
            document.getElementById('jsonOutput').textContent = JSON.stringify(config, null, 2);
            document.getElementById('outputSection').style.display = 'block';

            // Scroll to output
            document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });
        }

        function generateRandomHash() {
            return Array.from({length: 16}, () => Math.floor(Math.random() * 16).toString(16)).join('') + '...';
        }

        function copyToClipboard() {
            const jsonText = document.getElementById('jsonOutput').textContent;
            navigator.clipboard.writeText(jsonText).then(() => {
                alert('‚úÖ JSON configuration copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('‚ùå Failed to copy to clipboard. Please select and copy manually.');
            });
        }

        // Auto-format MAC address input
        document.getElementById('macAddress').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9A-Fa-f]/g, '').toUpperCase();
            if (value.length > 12) value = value.substr(0, 12);
            value = value.match(/.{1,2}/g)?.join(':') || value;
            if (value !== e.target.value) {
                e.target.value = value;
            }
        });

        // Set default expiry date (3 months from now)
        document.addEventListener('DOMContentLoaded', function() {
            const futureDate = new Date();
            futureDate.setMonth(futureDate.getMonth() + 3);
            document.getElementById('expiryDate').value = futureDate.toISOString().split('T')[0];
        });
    </script>
</body>
</html>